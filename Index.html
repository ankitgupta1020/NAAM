<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Radha Naam Jaap — Global Counter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #0a0a0c;
            --card: rgba(255, 255, 255, 0.06);
            --primary: #ff7043;
            --secondary: #f9c74f;
            --text: #ffffff;
            --accent: #f94144;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at center, #1a0f00 0%, #050505 100%);
            color: var(--text);
            height: 100dvh;
            overflow: hidden; /* Prevents bounce scrolling */
        }

        /* The Main Tap Area */
        .app-container {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px;
            position: relative;
        }

        .glass-panel {
            background: var(--card);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 20px;
            width: 100%;
            max-width: 450px;
        }

        .header { text-align: center; margin-top: 20px; }
        .header h1 { 
            margin: 0; font-size: 3rem; color: var(--accent); 
            text-shadow: 0 0 20px rgba(249, 65, 68, 0.4);
        }

        /* Counter Circle */
        .counter-section {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            width: 100%;
        }

        .main-ring {
            width: min(75vw, 320px);
            height: min(75vw, 320px);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.03);
            border: 4px solid var(--card);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            transition: transform 0.1s active;
        }

        .count-big {
            font-size: 5rem;
            font-weight: 900;
            margin: 0;
            background: linear-gradient(180deg, #fff 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Leaderboard styling */
        .leaderboard-tray {
            max-height: 30vh;
            overflow-y: auto;
            margin-top: 15px;
        }

        .user-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
        }

        .pill {
            background: var(--accent);
            padding: 2px 10px;
            border-radius: 10px;
            font-weight: bold;
        }

        button {
            background: var(--text);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 10px;
            color: #fff;
            outline: none;
        }

        .burst {
            position: absolute;
            pointer-events: none;
            color: var(--secondary);
            font-weight: 900;
            animation: flyUp 0.8s ease-out forwards;
        }

        @keyframes flyUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-100px) scale(1.5); }
        }

        .footer-tools { margin-bottom: 20px; display: flex; gap: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            const [count, setCount] = useState(0);
            const [user, setUser] = useState(null);
            const [globalBoard, setGlobalBoard] = useState([]);
            const [nameInput, setNameInput] = useState("");
            const [cityInput, setCityInput] = useState("");

            // Load local data on start
            useEffect(() => {
                const saved = localStorage.getItem('radha_user_v3');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    setUser(parsed);
                    setCount(parsed.lifetime || 0);
                }
                fetchGlobalBoard();
            }, []);

            const fetchGlobalBoard = async () => {
                try {
                    const res = await fetch('/.netlify/functions/leaderboard');
                    const data = await res.json();
                    setGlobalBoard(data);
                } catch (e) { console.log("Offline mode or function not ready"); }
            };

            const syncCountToCloud = async (id, amount) => {
                try {
                    await fetch('/.netlify/functions/increment', {
                        method: 'POST',
                        body: JSON.stringify({ user_id: id, amount: 1 })
                    });
                } catch (e) {}
            };

            const handleCreateProfile = async () => {
                if (!nameInput) return alert("Please enter name");
                try {
                    const res = await fetch('/.netlify/functions/create-profile', {
                        method: 'POST',
                        body: JSON.stringify({ name: nameInput, city: cityInput })
                    });
                    const newUser = await res.json();
                    setUser(newUser);
                    localStorage.setItem('radha_user_v3', JSON.stringify(newUser));
                } catch (e) {
                    // Fallback for offline/no backend
                    const localUser = { id: Date.now(), display_name: nameInput, city: cityInput, lifetime: 0 };
                    setUser(localUser);
                    localStorage.setItem('radha_user_v3', JSON.stringify(localUser));
                }
            };

            const handleTap = (e) => {
                if (!user) return;
                
                const newCount = count + 1;
                setCount(newCount);
                
                // Haptics
                if (navigator.vibrate) navigator.vibrate(10);

                // Visual Burst
                const burst = document.createElement('div');
                burst.className = 'burst';
                burst.innerHTML = 'राधा';
                burst.style.left = `${e.clientX || window.innerWidth/2}px`;
                burst.style.top = `${e.clientY || window.innerHeight/2}px`;
                document.body.appendChild(burst);
                setTimeout(() => burst.remove(), 800);

                // Sync
                syncCountToCloud(user.id, 1);
                
                // Update Local
                const updatedUser = { ...user, lifetime: newCount };
                setUser(updatedUser);
                localStorage.setItem('radha_user_v3', JSON.stringify(updatedUser));
            };

            return (
                <div className="app-container" onClick={handleTap}>
                    <header className="header">
                        <h1>राधा</h1>
                        <p style={{opacity: 0.6}}>Tap anywhere to chant</p>
                    </header>

                    {!user ? (
                        <div className="glass-panel" onClick={e => e.stopPropagation()}>
                            <div className="input-group">
                                <h3>Create Profile to Track</h3>
                                <input placeholder="Your Name" value={nameInput} onChange={e => setNameInput(e.target.value)} />
                                <input placeholder="Your City" value={cityInput} onChange={e => setCityInput(e.target.value)} />
                                <button onClick={handleCreateProfile}>Start Jaap</button>
                            </div>
                        </div>
                    ) : (
                        <div className="counter-section">
                            <div className="main-ring">
                                <p style={{margin:0, opacity:0.6}}>Total Naam</p>
                                <h2 className="count-big">{count}</h2>
                                <p style={{margin:0, color: 'var(--secondary)'}}>Mala: {Math.floor(count / 108)}</p>
                            </div>
                        </div>
                    )}

                    {user && (
                        <div className="glass-panel" onClick={e => e.stopPropagation()}>
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '10px'}}>
                                <strong>Global Leaderboard</strong>
                                <button style={{padding: '4px 8px', fontSize: '10px'}} onClick={fetchGlobalBoard}>Refresh</button>
                            </div>
                            <div className="leaderboard-tray">
                                {globalBoard.length > 0 ? globalBoard.map((u, i) => (
                                    <div className="user-row" key={i}>
                                        <span>{i+1}. {u.display_name} <small style={{opacity:0.5}}>{u.city}</small></span>
                                        <span className="pill">{u.weekly_total || 0}</span>
                                    </div>
                                )) : <p style={{fontSize: '12px', opacity:0.5}}>No global data found. Connect Supabase to see others.</p>}
                            </div>
                        </div>
                    )}

                    <div className="footer-tools" onClick={e => e.stopPropagation()}>
                        <button onClick={() => {if(confirm("Reset?")) {setCount(0); localStorage.clear(); location.reload();}}}>Reset</button>
                        <a href="upi://pay?pa=ankitgupta1181-5@oksbi&pn=Radha%20Jaap&cu=INR" style={{textDecoration:'none'}}>
                            <button style={{background: 'var(--accent)', color: '#fff'}}>❤️ Donate</button>
                        </a>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
